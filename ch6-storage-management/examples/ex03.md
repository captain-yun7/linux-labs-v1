### ex03 : 파일 시스템 생성, 마운트, fstab 등록

# 이 예제는 파티션을 포맷하고, 특정 디렉토리에 연결(마운트)하여
# 사용자가 실제로 파일을 읽고 쓸 수 있게 만드는 과정을 다룹니다.
# 또한, 시스템 재부팅 후에도 이 연결이 유지되도록 설정합니다.

#### 1. 실습 환경 준비 (ex02의 결과물)

```bash
# [1GB 가상 디스크 및 500MB 파티션 준비]
fallocate -l 1G vdisk.img
sudo losetup /dev/loop10 vdisk.img

# fdisk를 비대화형(non-interactive) 모드로 실행하여 파티션을 생성합니다.
# echo와 파이프(|)를 이용해 n, p, 1, Enter, +500M, w 순서로 명령을 전달합니다.
echo -e "n\np\n1\n\n+500M\nw" | sudo fdisk /dev/loop10

# [/dev/loop10p1 파티션이 생성되었는지 확인]
lsblk /dev/loop10
```

#### 2. 파일 시스템 생성 (포맷) 및 마운트

```bash
# [파티션을 ext4 파일 시스템으로 포맷]
# mkfs (make filesystem) 명령어로 디스크에 파일 시스템을 설치합니다.
sudo mkfs.ext4 /dev/loop10p1

# [마운트 포인트로 사용할 디렉토리 생성]
# 마운트 포인트는 디스크가 연결될 비어있는 디렉토리입니다.
sudo mkdir /data

# [파티션을 마운트 포인트에 연결]
# mount [디바이스] [마운트포인트] 명령으로 연결합니다.
sudo mount /dev/loop10p1 /data

# [마운트 결과 확인]
# df -hT 명령어로 /data에 디바이스가 잘 연결되었는지 확인합니다.
df -hT
```

#### 3. fstab을 이용한 영구 마운트

```bash
# [/etc/fstab 파일에 마운트 정보 등록]
# 재부팅 시 마운트 정보를 잃지 않으려면 /etc/fstab 파일에 등록해야 합니다.

# [디바이스의 고유 ID(UUID) 확인]
# 디바이스 이름(/dev/loop10p1)은 바뀔 수 있으므로, 고유 ID인 UUID를 사용하는 것이 안전합니다.
sudo blkid /dev/loop10p1

# [/etc/fstab 파일 백업]
# 중요 설정 파일 수정 전에는 항상 백업하는 습관을 들입니다.
sudo cp /etc/fstab /etc/fstab.bak

# [/etc/fstab 파일에 내용 추가]
# 'UUID=[UUID값] /data ext4 defaults 0 2' 형식의 라인을 추가합니다.
# tee 명령어를 사용하면 root 권한으로 파일에 내용을 추가할 수 있습니다.
UUID=$(sudo blkid -s UUID -o value /dev/loop10p1)
echo "UUID=$UUID /data ext4 defaults 0 2" | sudo tee -a /etc/fstab

# [fstab 설정 테스트]
# 먼저 현재 마운트를 해제합니다.
sudo umount /data
# 'mount -a'는 fstab의 모든 내용을 마운트하는 명령어입니다. 오류가 없으면 성공입니다.
sudo mount -a
# df 명령어로 다시 마운트되었는지 확인합니다.
df -hT
```

#### 4. 실습 마무리

```bash
# [fstab 파일 원상 복구]
sudo mv /etc/fstab.bak /etc/fstab

# [마운트 해제 및 디렉토리/파일 삭제]
sudo umount /data
sudo losetup -d /dev/loop10
rm vdisk.img
sudo rmdir /data
``` 