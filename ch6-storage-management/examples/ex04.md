### ex04 : LVM으로 유연한 스토리지 구축

# LVM(Logical Volume Manager)은 여러 개의 디스크를 하나의 큰 저장소처럼
# 합치고, 그 안에서 파티션(논리 볼륨)의 크기를 마음대로 조절할 수 있게
# 해주는 매우 강력한 스토리지 관리 기술입니다.

#### 1. LVM 실습 환경 준비

```bash
# [실습용 가상 디스크 2개 생성]
fallocate -l 1G vdisk1.img
fallocate -l 1G vdisk2.img

# [가상 디스크들을 시스템에 연결]
sudo losetup /dev/loop10 vdisk1.img
sudo losetup /dev/loop11 vdisk2.img

# [각 디스크에 LVM 타입의 파티션 생성]
# fdisk를 비대화형으로 실행하여 파티션을 만들고 타입을 'Linux LVM'(ID: 8e)으로 지정합니다.
echo -e "n\np\n1\n\n\nt\n8e\nw" | sudo fdisk /dev/loop10
echo -e "n\np\n1\n\n\nt\n8e\nw" | sudo fdisk /dev/loop11

# [결과 확인]
# /dev/loop10p1, /dev/loop11p1 파티션이 생성되었는지 확인합니다.
lsblk
```

#### 2. LVM 구성하기 (PV -> VG -> LV)

```bash
# [1. PV(Physical Volume) 생성]
# LVM에서 사용할 물리 파티션을 PV로 초기화합니다.
sudo pvcreate /dev/loop10p1 /dev/loop11p1

# [PV 생성 확인]
sudo pvs

# [2. VG(Volume Group) 생성]
# 여러 개의 PV들을 'my_vg'라는 이름의 볼륨 그룹으로 묶습니다.
# 이제 약 2GB의 거대한 저장소 풀(pool)이 만들어집니다.
sudo vgcreate my_vg /dev/loop10p1 /dev/loop11p1

# [VG 생성 확인]
sudo vgs

# [3. LV(Logical Volume) 생성]
# VG라는 저장소 풀에서 필요한 만큼 논리 볼륨(실제 사용할 파티션)을 할당받습니다.
# -n LV이름, -L LV크기, VG이름 순서로 입력합니다.
sudo lvcreate -n logs -L 500M my_vg
sudo lvcreate -n apps -L 1G my_vg

# [LV 생성 확인]
sudo lvs
# lsblk로도 전체 구조를 확인할 수 있습니다.
lsblk
```

#### 3. 논리 볼륨 포맷 및 사용

```bash
# [LV 포맷하기]
# 생성된 LV는 /dev/VG이름/LV이름 경로의 장치 파일로 접근할 수 있습니다.
# 일반 파티션처럼 파일 시스템을 생성(포맷)합니다.
sudo mkfs.ext4 /dev/my_vg/logs
sudo mkfs.ext4 /dev/my_vg/apps

# [마운트하고 사용하기]
sudo mkdir -p /mnt/logs /mnt/apps
sudo mount /dev/my_vg/logs /mnt/logs
sudo mount /dev/my_vg/apps /mnt/apps

# [마운트 결과 확인]
df -hT
```

#### 4. LVM 핵심 기능: 온라인 볼륨 확장

```bash
# [VG의 남은 공간 확인]
# vgs 명령어로 'my_vg'에 VFree(남은 공간)가 얼마나 있는지 확인합니다.
sudo vgs

# [LV 용량 확장 및 파일 시스템 리사이즈]
# lvextend 명령어로 'apps' 볼륨을 500MB만큼 늘려보겠습니다.
# --resizefs 옵션을 붙이면, LV 크기 확장 후 파일 시스템 크기까지 자동으로 맞춰줍니다.
sudo lvextend -L +500M --resizefs /dev/my_vg/apps

# [확장 결과 확인]
# lvs와 df 명령어로 'apps' 볼륨의 크기가 실제로 늘어났는지 확인합니다.
sudo lvs
df -hT
```

#### 5. 실습 마무리

```bash
# [역순으로 제거: 마운트 해제 -> LV 제거 -> VG 제거 -> PV 제거]
sudo umount /mnt/logs /mnt/apps
sudo lvremove -y /dev/my_vg/logs /dev/my_vg/apps
sudo vgremove -y my_vg
sudo pvremove /dev/loop10p1 /dev/loop11p1

# [가상 디스크 연결 해제 및 파일 삭제]
sudo losetup -d /dev/loop10
sudo losetup -d /dev/loop11
rm vdisk1.img vdisk2.img
sudo rmdir /mnt/logs /mnt/apps
``` 